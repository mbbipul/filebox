<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>File Box</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  
  <link rel="icon" type="image/png" href="/icons/icons8-box-64.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/icons/icons8-box-64.png" sizes="16x16">
  <link href="/fontawesome-free-5.11.2-web/css/all.min.css" rel="stylesheet"> <!--load all styles -->
    <meta name="theme-color" content="#4b0596">
  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/tether.min.js"></script>
  <script src="/js/bootstrap-4.0.0-alpha.6.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <link rel="stylesheet" href="/css/bootstrap2.min.css" >  
  <style type="text/css">
 	body,html{
			height: 100%;
			margin: 0;
			background: #7F7FD5;
	       background: -webkit-linear-gradient(to right, #91EAE4, #86A8E7, #7F7FD5);
	        background: linear-gradient(to right, #91EAE4, #86A8E7, #7F7FD5);
		}

		.chat{
			margin-top: auto;
			margin-bottom: auto;
		}
		.card{
			height: 500px;
			border-radius: 15px !important;
			background-color: rgba(0,0,0,0.4) !important;
		}
		.contacts_body{
			padding:  0.75rem 0 !important;
			overflow-y: auto;
			white-space: nowrap;
		}
		.msg_card_body{
			overflow-y: auto;
		}
		.card-header{
			border-radius: 15px 15px 0 0 !important;
			border-bottom: 0 !important;
		}
	 .card-footer{
		border-radius: 0 0 15px 15px !important;
			border-top: 0 !important;
	}
		.container{
			align-content: center;
		}
		.search{
			border-radius: 15px 0 0 15px !important;
			background-color: rgba(0,0,0,0.3) !important;
			border:0 !important;
			color:white !important;
		}
		.search:focus{
		     box-shadow:none !important;
           outline:0px !important;
		}
		.type_msg{
			background-color: rgba(0,0,0,0.3) !important;
			border:0 !important;
			color:white !important;
			height: 60px !important;
			overflow-y: auto;
		}
			.type_msg:focus{
		     box-shadow:none !important;
           outline:0px !important;
		}
		.attach_btn{
	border-radius: 15px 0 0 15px !important;
	background-color: rgba(0,0,0,0.3) !important;
			border:0 !important;
			color: white !important;
			cursor: pointer;
		}
		.send_btn{
	border-radius: 0 15px 15px 0 !important;
	background-color: rgba(0,0,0,0.3) !important;
			border:0 !important;
			color: white !important;
			cursor: pointer;
		}
		.search_btn{
			border-radius: 0 15px 15px 0 !important;
			background-color: rgba(0,0,0,0.3) !important;
			border:0 !important;
			color: white !important;
			cursor: pointer;
		}
		.contacts{
			list-style: none;
			padding: 0;
		}
		.contacts li{
			width: 100% !important;
			padding: 5px 10px;
			margin-bottom: 15px !important;
		}
	.active{
			background-color: rgba(0,0,0,0.3);
	}
		.user_img{
			height: 70px;
			width: 70px;
			border:1.5px solid #f5f6fa;
		
		}
		.user_img_msg{
			height: 40px;
			width: 40px;
			border:1.5px solid #f5f6fa;
		
		}
	.img_cont{
			position: relative;
			height: 70px;
			width: 70px;
	}
	.img_cont_msg{
			height: 40px;
			width: 40px;
	}
	.online_icon{
		position: absolute;
		height: 15px;
		width:15px;
		border-radius: 50%;
		bottom: 0.2em;
		right: 0.4em;
	}
	.offline{
		background-color: #c23616 !important;
	}
	.user_info{
		margin-top: auto;
		margin-bottom: auto;
		margin-left: 15px;
	}
	.user_info span{
		font-size: 20px;
		color: white;
	}
	.user_info p{
	font-size: 10px;
	color: rgba(255,255,255,0.6);
	}
	.video_cam{
		margin-left: 50px;
		margin-top: 5px;
	}
	.video_cam span{
		color: white;
		font-size: 20px;
		cursor: pointer;
		margin-right: 20px;
	}
	.msg_cotainer{
		margin-top: auto;
		margin-bottom: auto;
		margin-left: 10px;
		border-radius: 25px;
		background-color: #82ccdd;
		padding: 10px;
		position: relative;
	}
	.msg_cotainer_send{
		margin-top: auto;
		margin-bottom: auto;
		margin-right: 10px;
		border-radius: 25px;
		background-color: #78e08f;
		padding: 10px;
		position: relative;
	}
	.msg_time{
		position: absolute;
		left: 0;
		bottom: -15px;
		color: rgba(255,255,255,0.5);
		font-size: 10px;
	}
	.msg_time_send{
		position: absolute;
		right:0;
		bottom: -15px;
		color: rgba(255,255,255,0.5);
		font-size: 10px;
	}
	.msg_head{
		position: relative;
	}
	#action_menu_btn{
		position: absolute;
		right: 10px;
		top: 10px;
		color: white;
		cursor: pointer;
		font-size: 20px;
	}
	.action_menu{
		z-index: 1;
		position: absolute;
		background-color: rgba(0,0,0,0.5);
		color: white;
		top: 30px;
		left: 80px;
    width: 300px!important;
		display: none;
    border-radius: 10px;

	}
	.action_menu ul{
		list-style: none;
		padding: 0;
	margin: 0;
	}
	.action_menu ul li{
		width: 100%;
		margin-bottom: 5px;
    padding: 10px;
    border-radius: 10px;
	}
	.action_menu ul li i{
		padding-right: 10px;
	
	}
	.action_menu ul li:hover{
		cursor: pointer;
		background-color: rgba(0,0,0,0.2);
	}
	@media(max-width: 576px){
	.contacts_card{
		margin-bottom: 15px !important;
	}
	}
    #action_menu_btn{
      position: inherit;
      right: 10px;
      top: 10px;
      color: white;
      cursor: pointer;
      font-size: 20px;
	}

	
  .mt-4  {
    margin-top : 40px;
  }
  #successoverlay {
    display: none;
    z-index: 1000;
  }
  body.success > #successoverlay {
    display:block;
    position: fixed;
    top:0;
    bottom:0;
    left:0;
    right:0;
    background: rgba(0, 0, 0, 0.65);
    z-index: 1000;
    text-align: center;
    padding: 10vw;
  }
  body.success > #successoverlay > .title {
    color: white;
    font-family: monospace;
    font-size: 64px;
    text-shadow: 0 0 20px black;
  }
  
  .noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }
  
  #IPandPort {
    color: #4b0596;
    font-family: monospace;
    line-height: 40px;
  }


  .list-item {
    display: flex;
    align-items: flex-end;
  }
  .list-group-item {
    word-break: break-word;
    flex: 1;
  }
  .list-group-item-close {
    margin-bottom: 2rem;
    margin-left: -1.5rem;
    z-index: 2;
  }

  .hiddenFileInput  .hide{
  height: 10%;
  width: 80;
  opacity: 0;
  cursor: pointer;
}
.hiddenFileInput{
  width: 30px;
  height: 30px;
  display: inline-block;
  overflow: hidden;
  
  /*for the background, optional*/
  background: center center no-repeat;
  background-size: 75% 75%;
  background-image:  url(/icons/filled-sent.png)
}

input#fileToUpload {
  display: inline-block;
  width: 100%;
  padding: 120px 0 0 0;
  height: 100px;
  overflow: hidden;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  background: url('/icons/698394-icon-130-cloud-upload-512.png') center center no-repeat #e4e4e4;
  border-radius: 20px;
  background-size: 60px 60px;
}

.btn-upload {
  position: relative;
  overflow: hidden;
}
.btn-upload input {
  position: absolute;
  font-size: 10px;
  opacity: 0;
  right: 0;
  top: 0;
}
  </style>
  
</head>
<body>
  
  <div class="container">
      <h1 class="text-center"> File Box</h1> 

    <div class="row">
        <div class="col-lg-8  col-md-6 col-md-offset-3 col-sm-12 text-center">
          <div class="row">
              <div class="col-lg-6 col-md-6 text-center">
                  <div class="card-header msg_head" style="margin-top: 30px;">
                      <div class="d-flex bd-highlight">
                        <div class="img_cont">
                          <img src="https://static.turbosquid.com/Preview/001292/481/WV/_D.jpg" class="rounded-circle user_img">
                          <i id="chnage_name_pic" class="online_icon fas fa-edit"></i>
                          <div class="action_menu">
                            <ul>
                              <li><i class="fas fa-user-circle"></i>Change Profile Picture</li>
                              <li data-toggle="modal" data-target="#exampleModalCenter"><i class="fas fa-edit" ></i>Change Name</li>
                            </ul>
                          </div>
                        </div>
                        <div class="user_info">
                          <span id="user_name"></span>
                          <h6 id="client_ip"></h6>
                        </div>
        
                      </div>
        
                    </div>
              </div>
              <div class="col-lg-6 col-md-6 text-center">
                  <strong>Hit this link 
                    <span id="IPandPort"></span> or Scan qr code </strong>
                  <img id="theQRCode" style="border-radius: 25px!important;height: 100px;">

                </div>
           </div>
          <form ref='uploadForm' id='uploadForm' action="" method="post" enctype="multipart/form-data">
            <input type="text" name="destip" value="all" hidden>

            <input type="file"  name="fileToUpload" id="fileToUpload">
          </form>
          
          <br>
          
          <div id="successPanel" class="panel panel-success" hidden>
            <div class="panel-body text-center">
              <p class="text-success" style="margin:0;">File uploaded as "<span id="fileSuccessName"></span>"</p>
            </div>
          </div>
          
          <div id="errorPanel" class="panel panel-danger" hidden>
            <div class="panel-body text-center">
              <p class="text-danger" style="margin:0;">File upload failed.</p>
            </div>
          </div>
          
          <br>
          
          <div id="fileList" class="list-group">
          </div>
          
        </div>
      <div class="col-lg-4 text-center mt-4" >
        Connected Devices
        <table class="table">
          <thead>
            <tr>
              <th scope="col">device id</th>
              <th scope="col">device ip</th>
            </tr>
          </thead>
          <tbody id="local_device_list">

          </tbody>
        </table>
      </div>
    </div>

  </div>
  
 
  <div id="successoverlay">
    <span class="title noselect">&nbsp;&nbsp;&nbsp;Uploading...</span>
  </div>
  

  <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
      <form method="post" action="/editusername">  
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalCenterTitle">Modal title</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <input type="text" name="username" required class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </form>

    </div>
  <script type="text/javascript">
  
  /* Getting server info */
  
  var IPandPort = document.getElementById('IPandPort');
  var updateAddress = function (addresses,port) {
    if(!(addresses instanceof Array)) return;
    IPandPort.innerHTML = addresses[1]+":8080";
    // IPandPort.innerHTML = addresses.map(function (address) {
    //   return [address, port].join(":");
    // }).join("</br>");
    if(addresses.length > 0) {
      document.getElementById("theQRCode").setAttribute("src", `/qr_codes/${addresses[1]}_${port}.png`)
    } else {
      document.getElementById("theQRCode").setAttribute("src", "");
    }
  }
  updateLocalDeviceList();
  var previousFileNames = null;
  var fileList = document.getElementById('fileList');

  var updateFileList = function (fileNames, allowDeletion) {
    if (!(fileNames instanceof Array)) {
      fileList.innerHTML = "";
      return;
    }
    if (arrayEquals(previousFileNames, fileNames)) {
      return;
    }
    
    //TODO do this with document.createElement
    fileList.innerHTML = fileNames.map(function(fileName) {
      return `<div class=" ">
        <a target="_blank" href="./f/`+fileName+`" class="list-group-item dropdown" download>`+fileName+`<i style="float:right" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="fa fa-ellipsis-h"></i></a>
        ${allowDeletion ? `<a class="list-group-item-close" href="javascript:void(0);" onclick="deleteFile('`+fileName+`')">&times;</a>` : ''}
        </div>`;
    }).join('');
    
    previousFileNames = fileNames;
  }
  
  function arrayEquals(ar1, ar2) {
    if (ar1 == null) {
      return ar2 == null;
    }
    if (ar2 == null) {
      return ar1 == null;
    }
    if (ar1.length != ar2.length) {
      return false;
    } else {
      for (let index = 0; index < ar1.length; index++) {
        if (ar1[index] != ar2[index]) return false;
      }
      return true;
    }
  }


const getClientIp = function(url, callback) // How can I use this callback?
{
    var request = new XMLHttpRequest();
    request.onreadystatechange = function()
    {
        if (request.readyState == 4 && request.status == 200)
        {
            callback(request.responseText); // Another callback here
        }
    }; 
    request.open('GET', url);
    request.send();
}

function clientCallback(data) {
    data = JSON.parse(data);
    document.getElementById('client_ip').innerText = data;
}
getClientIp('/clientip', clientCallback);


function updateLocalDeviceList(){
  var xmlhttp = new XMLHttpRequest();

  xmlhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var myArr = JSON.parse(this.responseText);
      addrow(myArr);
    }
  };
  xmlhttp.open("GET", "/localdevices", true);
  xmlhttp.send();


  }

  function addrow(arr) {
    var table_body = document.getElementById("local_device_list");
    table_body.innerHTML = "";
    addTableRows("Host",arr[1],table_body);
    arr[0].forEach(element => {
      addTableRows(element.name,element.ip,table_body);

    });
  }

  var deleteFile =  function (fileName) {
    if (!confirm("Are you sure?")) return;
    var request = new XMLHttpRequest()
    request.open('GET', `./f/del/`+fileName, true)
    request.send();
  }
  
  var getServerInfoWithFiles = function (callback) {
    var request = new XMLHttpRequest();
    request.open('GET', '/infowithfile', true);
    
    var onError = function (caller) {
      //TODO check if offline (or server is down)
      console.log(request);
    }
    
    request.onload = function() {
      if (request.status >= 200 && request.status < 400) {
        // Success!
        var resp = request.responseText;
        var data = JSON.parse(resp);
        if("addresses" in data && "port" in data){
          updateAddress(data["addresses"],data["port"]);
        }
        if("fileList" in data){
          updateFileList(data["fileList"], data["allowDeletion"]);
        }
      } else {
        onError(0);
      }
    };
    
    request.onerror = function(){onError(1);};
    
    request.send();
  }
  
  getServerInfoWithFiles();
  setInterval(function () {
    getServerInfoWithFiles();
   // updateLocalDeviceList();
  },2000);
  
  
  /* Query based upload success error stuff */
  
  var queryText = location.search;
  
  //Clearing query.
  window.history.pushState('obj', document.title, "http://" + location.host + location.pathname);
  
  //TODO do this properly
  var successIndex = queryText.startsWith("?success=");
  if(successIndex){
    var successPanel = document.getElementById('successPanel');
    if(successPanel) successPanel.className = successPanel.removeAttribute('hidden');
    
    var fileSuccessName = document.getElementById('fileSuccessName');
    fileSuccessName.innerText = decodeURIComponent(queryText.substring(9));
    
  } else if(queryText.startsWith("?error=")){
    var errorPanel = document.getElementById('errorPanel');
    if(errorPanel) errorPanel.className = errorPanel.removeAttribute('hidden');
  }
  
  /* Drag n Drop Upload */
  
  var holder = document.body;
  var fileToUploadButton = document.getElementById('fileToUploadButton');
  
  holder.ondragover = function (e) {
    e.preventDefault();
    e.stopPropagation();
    var x = e.pageX;
    var y = e.pageY;
    
    fileToUploadButton.style.position = "fixed";
    fileToUploadButton.style.top = (y - 11) + "px";
    fileToUploadButton.style.left = (x - 40) + "px";
    
  };
  
  var fixButtonBack = function () { fileToUploadButton.style.position = "static"; }
  holder.ondragend = fixButtonBack;
  holder.ondragexit = fixButtonBack;
  holder.ondragleave = function (e) {
    //console.log("holder.ondragleave",e);
    if (e.target == fileToUpload
      || e.pageX <= 10 || e.pageX >= window.innerWidth-10
      || e.pageY <= 10 || e.pageY >= window.innerHeight-10) {
        fixButtonBack();
    }
    }
    holder.ondrop = function (e) {
      if(e.target != fileToUpload){
        e.preventDefault();
      }
      fixButtonBack();
    }
    
    
    var fileToUpload = document.getElementById('fileToUpload');
    fileToUpload.onchange = function (e) {
      holder.className += "success";
      setTimeout(function() {
        fileToUpload.form.submit();
      }, 1);
    }
    
    
 
      function addTableRows(name,ip,table_body){
        var ipToString = ip.split('.').join("");
        var row = document.createElement("tr");

        var file_icon = '<form  ref="uploadForm" id="uploadForm" action="" \
        method="post" enctype="multipart/form-data">\
            <input type="text" name="destip" value="'+ip+'" hidden>\
            <i class="btn-upload fas fa-share"><input type="file"  name="fileToUpload" onchange="this.form.submit()" /></i>\
          </form>';

        var a ='<span id="action_menu_btn" \
        ><i class="fas fa-ellipsis-v" id="'+ipToString+'"></i></span>';
        
            var td = "<td>"+name+"</td><td>"+ip+"</td><td>"+a+"</td>";
            row.innerHTML= td;
            var row2 =document.createElement('tr');
            row2.id = ipToString;
            row2.setAttribute('hidden',true);

            row2.innerHTML = '<td scope="row">'+file_icon+'</td>\
              <td colspan="2"><a class="text-dark " href="/chat?'+ip+'"><i class="fab fa-whatsapp"></i></a></td>';
            table_body.append(row);
            table_body.append(row2);
            var btn = document.getElementById(ipToString);
            btn.addEventListener('click', function () {
              if (row2.hasAttribute("hidden")) {
                  $(row2).fadeIn( "slow" );
                  $(row2).attr("hidden", false);
              } else {
                $(row2).fadeOut( "slow" );
                $(row2).attr("hidden", true);
              }
            }, false);
      };

      
    function sendFile(id){
      var fileToUpload = document.getElementById(id);
        setTimeout(function() {
          fileToUpload.form.submit();
        }, 1);
    }
    function updateUserInfo(id) {
      var xmlhttp = new XMLHttpRequest();

      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          var user = JSON.parse(this.responseText);
          console.log(user);
          document.getElementById('user_name').innerText = user[0].name;
        }
      };
      xmlhttp.open("GET", "/getuserinfoforchatroom/"+id, true);
      xmlhttp.send();
	  }
    $(document).ready(function(){
      $('#chnage_name_pic').click(function(){
        $('.action_menu').toggle();
      });
      getClientIp('/clientip', updateUserInfoCallback);
  });
    function updateUserInfoCallback(data){
        data = JSON.parse(data);
        console.log(data);
        updateUserInfo(data);
      }
    </script>
  </body>
  </html>